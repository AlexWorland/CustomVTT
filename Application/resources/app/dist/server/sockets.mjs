import ServerError from"./error.mjs";import Activity from"../components/activity.mjs";import Files from"../files/files.mjs";import sessions from"../sessions.mjs";import ProseMirrorAuthority from"../components/prosemirror.mjs";export async function handleEvent(e,s,t,r){const o=this.user;if(!o)throw new Error(`Unrecognized User attacked to socket ${this.id} for event ${e}`);t.options=t.options||{};let i=t.options.broadcast??!0,n={userId:o?.id,request:t};try{n.result=await s(o,t)}catch(e){e=new ServerError(e.message,e.stack),logger.error(e),n.error=e,i=!1}return r?(r(n),i&&this.broadcast.emit(e,n)):i&&this.server.emit(e,n),n}export function handleCustomSocket(e,s,{recipients:t}={},r){if(t instanceof Array)for(let r of t){const t=game.users.find((e=>e.id===r));if(t)for(let r of t.sockets)r.emit(e,s,this.user.id)}else this.broadcast.emit(e,s,this.user.id);r instanceof Function&&r()}export async function activate(e,s){const t=e.handshake.query,r={sessionId:null,userId:null},o=sessions.sessions.get(t.session);if(!o)return e.emit("session",null);if(e.session=o,r.sessionId=o.id,game.world&&game.ready){const s=o.worlds[game.world.id],t=game.users.find((e=>e.id===s));t?(e.user=t,e.userId=r.userId=t.id):delete o.worlds[game.world.id]}e.emit("session",r);for(const t of s)t.socket&&e.on(t.socket,(e=>t.handleSocket(o,e)));e.on("getWorldStatus",requestWorldState),Files.socketListeners(e,handleEvent),r.userId&&(Activity.socketListeners(e),e.on("chatBubble",handleCustomSocket.bind(e,"chatBubble")),e.on("av",handleCustomSocket.bind(e,"av")),ProseMirrorAuthority.socketListeners(e),db.DatabaseBackend.socketListeners(e),db.Scene.socketListeners(e),db.JournalEntry.socketListeners(e),db.Playlist.socketListeners(e),db.FogExploration.socketListeners(e),db.Actor.socketListeners(e),packages.World.socketListeners(e,handleEvent))}function requestWorldState(e){return e(game.world&&game.ready)}