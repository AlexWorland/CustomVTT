import sessions from"../../sessions.mjs";import{Module}from"../../packages/_module.mjs";import{PASSWORD_SAFE_STRING,USER_ROLES}from"../../../common/constants.mjs";import View from"./view.mjs";export default class PlayersView extends View{route="/players";socket="getPlayersData";_template="players";_methods=["get"];async handleGet(e,s){const{db:t,game:r}=global;if(!r.world)return s.redirect(`${e.baseUrl}/setup`),!1;const o=await t.User.getUsers();if(!this._isAuthorized(o,e.user))return s.redirect(`${e.baseUrl}/join`),!1;const a=r.world?r.world.background:null,i=View._getStaticContent({setup:!0});s.render(this._template,{bodyClass:"vtt players "+(a?"background":""),bodyStyle:`background-image: url('${a||"ui/denim075.png"}')`,messages:sessions.getMessages(e),scripts:i.scripts,styles:i.styles})}async handleSocket(e,s){if(!game.world||!game.ready)return s({});const t=await db.User.dump(),r=e.worlds[game.world.id];return this._isAuthorized(game.users,r)?s({users:t,release:global.release,modules:Module.getPackages({coreTranslation:!0}).map((e=>e.vend())),passwordString:PASSWORD_SAFE_STRING,settings:await db.Setting.dump(),userId:e.worlds[game.world.id]||null,options:{language:global.config.options.language}}):s({})}_isAuthorized(e,s){const t=e.find((e=>e.id===s)),r=e.some((e=>e.hasRole(USER_ROLES.GAMEMASTER)));return t?.isGM||!r}}